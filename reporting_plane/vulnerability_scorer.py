"""
CVSS v3.1 Vulnerability Scorer
Calculates Common Vulnerability Scoring System (CVSS) scores for findings
"""

from typing import Dict, Optional
from enum import Enum


class AttackVector(str, Enum):
    """Attack Vector (AV)"""
    NETWORK = "N"
    ADJACENT = "A"
    LOCAL = "L"
    PHYSICAL = "P"


class AttackComplexity(str, Enum):
    """Attack Complexity (AC)"""
    LOW = "L"
    HIGH = "H"


class PrivilegesRequired(str, Enum):
    """Privileges Required (PR)"""
    NONE = "N"
    LOW = "L"
    HIGH = "H"


class UserInteraction(str, Enum):
    """User Interaction (UI)"""
    NONE = "N"
    REQUIRED = "R"


class Scope(str, Enum):
    """Scope (S)"""
    UNCHANGED = "U"
    CHANGED = "C"


class Impact(str, Enum):
    """Confidentiality, Integrity, Availability Impact (C/I/A)"""
    NONE = "N"
    LOW = "L"
    HIGH = "H"


class CVSSScorer:
    """Calculate CVSS v3.1 scores"""

    # CVSS v3.1 metric weights
    WEIGHTS = {
        "AV": {"N": 0.85, "A": 0.62, "L": 0.55, "P": 0.2},
        "AC": {"L": 0.77, "H": 0.44},
        "PR": {
            "U": {"N": 0.85, "L": 0.62, "H": 0.27},
            "C": {"N": 0.85, "L": 0.68, "H": 0.5}
        },
        "UI": {"N": 0.85, "R": 0.62},
        "C": {"N": 0, "L": 0.22, "H": 0.56},
        "I": {"N": 0, "L": 0.22, "H": 0.56},
        "A": {"N": 0, "L": 0.22, "H": 0.56}
    }

    @staticmethod
    def calculate_base_score(
        attack_vector: AttackVector,
        attack_complexity: AttackComplexity,
        privileges_required: PrivilegesRequired,
        user_interaction: UserInteraction,
        scope: Scope,
        confidentiality: Impact,
        integrity: Impact,
        availability: Impact
    ) -> Dict[str, any]:
        """
        Calculate CVSS v3.1 Base Score

        Returns:
            {
                "base_score": 7.5,
                "severity": "HIGH",
                "vector_string": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
                "exploitability": 3.9,
                "impact": 3.6
            }
        """
        weights = CVSSScorer.WEIGHTS

        # Get metric values
        av = weights["AV"][attack_vector.value]
        ac = weights["AC"][attack_complexity.value]
        pr = weights["PR"][scope.value][privileges_required.value]
        ui = weights["UI"][user_interaction.value]
        c = weights["C"][confidentiality.value]
        i = weights["I"][integrity.value]
        a = weights["A"][availability.value]

        # Calculate Impact Sub-Score (ISS)
        iss_base = 1 - ((1 - c) * (1 - i) * (1 - a))

        if scope == Scope.UNCHANGED:
            impact = 6.42 * iss_base
        else:
            impact = 7.52 * (iss_base - 0.029) - 3.25 * pow(iss_base - 0.02, 15)

        # Calculate Exploitability Sub-Score
        exploitability = 8.22 * av * ac * pr * ui

        # Calculate Base Score
        if impact <= 0:
            base_score = 0.0
        else:
            if scope == Scope.UNCHANGED:
                base_score = min(impact + exploitability, 10.0)
            else:
                base_score = min(1.08 * (impact + exploitability), 10.0)

        # Round up to nearest 0.1
        base_score = round(base_score * 10) / 10

        # Determine severity
        severity = CVSSScorer.get_severity(base_score)

        # Build vector string
        vector = (
            f"CVSS:3.1/"
            f"AV:{attack_vector.value}/"
            f"AC:{attack_complexity.value}/"
            f"PR:{privileges_required.value}/"
            f"UI:{user_interaction.value}/"
            f"S:{scope.value}/"
            f"C:{confidentiality.value}/"
            f"I:{integrity.value}/"
            f"A:{availability.value}"
        )

        return {
            "base_score": base_score,
            "severity": severity,
            "vector_string": vector,
            "exploitability": round(exploitability, 1),
            "impact": round(impact, 1)
        }

    @staticmethod
    def get_severity(score: float) -> str:
        """Get severity rating from CVSS score"""
        if score == 0:
            return "NONE"
        elif score < 4.0:
            return "LOW"
        elif score < 7.0:
            return "MEDIUM"
        elif score < 9.0:
            return "HIGH"
        else:
            return "CRITICAL"

    @staticmethod
    def auto_score_from_attack(attack_name: str, success: bool) -> Dict[str, any]:
        """
        Automatically estimate CVSS score from attack type and result

        This provides reasonable defaults based on attack category
        """

        # Default unsuccessful attack
        if not success:
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.NONE,
                Scope.UNCHANGED,
                Impact.NONE,
                Impact.NONE,
                Impact.NONE
            )

        attack_lower = attack_name.lower()

        # SQL Injection - Critical
        if "sql" in attack_lower and "injection" in attack_lower:
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.NONE,
                Scope.CHANGED,
                Impact.HIGH,
                Impact.HIGH,
                Impact.HIGH
            )

        # XSS - High
        if "xss" in attack_lower or "cross-site scripting" in attack_lower:
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.REQUIRED,
                Scope.CHANGED,
                Impact.LOW,
                Impact.LOW,
                Impact.NONE
            )

        # Authentication bypass - Critical
        if "auth" in attack_lower and ("bypass" in attack_lower or "brute" in attack_lower):
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.NONE,
                Scope.UNCHANGED,
                Impact.HIGH,
                Impact.HIGH,
                Impact.HIGH
            )

        # Directory traversal - High
        if "directory" in attack_lower or "path traversal" in attack_lower:
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.LOW,
                UserInteraction.NONE,
                Scope.UNCHANGED,
                Impact.HIGH,
                Impact.NONE,
                Impact.NONE
            )

        # Information disclosure / Reconnaissance - Medium
        if any(x in attack_lower for x in ["nmap", "recon", "enumeration", "discovery"]):
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.NONE,
                Scope.UNCHANGED,
                Impact.LOW,
                Impact.NONE,
                Impact.NONE
            )

        # SSRF - High
        if "ssrf" in attack_lower or "server-side request forgery" in attack_lower:
            return CVSSScorer.calculate_base_score(
                AttackVector.NETWORK,
                AttackComplexity.LOW,
                PrivilegesRequired.NONE,
                UserInteraction.NONE,
                Scope.CHANGED,
                Impact.HIGH,
                Impact.LOW,
                Impact.NONE
            )

        # Default - Medium
        return CVSSScorer.calculate_base_score(
            AttackVector.NETWORK,
            AttackComplexity.LOW,
            PrivilegesRequired.LOW,
            UserInteraction.NONE,
            Scope.UNCHANGED,
            Impact.LOW,
            Impact.LOW,
            Impact.NONE
        )


def score_vulnerability(
    name: str,
    description: str,
    attack_type: Optional[str] = None,
    success: bool = True,
    custom_vector: Optional[str] = None
) -> Dict[str, any]:
    """
    Score a vulnerability finding

    Args:
        name: Vulnerability name
        description: Description of the finding
        attack_type: Type of attack that found it
        success: Whether attack was successful
        custom_vector: Optional custom CVSS vector string

    Returns:
        {
            "name": "SQL Injection",
            "description": "...",
            "cvss": {
                "base_score": 9.8,
                "severity": "CRITICAL",
                "vector_string": "CVSS:3.1/...",
                "exploitability": 3.9,
                "impact": 5.9
            }
        }
    """

    if custom_vector:
        # Parse custom CVSS vector (simplified)
        # In production, you'd parse the full vector string
        pass

    # Auto-score based on attack type
    if attack_type:
        cvss = CVSSScorer.auto_score_from_attack(attack_type, success)
    else:
        cvss = CVSSScorer.auto_score_from_attack(name, success)

    return {
        "name": name,
        "description": description,
        "cvss": cvss
    }


if __name__ == "__main__":
    # Example usage
    print("Testing CVSS Scorer:")
    print()

    # SQL Injection
    vuln1 = score_vulnerability(
        "SQL Injection in login form",
        "The application is vulnerable to SQL injection attacks",
        attack_type="SQL Injection",
        success=True
    )
    print(f"SQL Injection: {vuln1['cvss']['base_score']} ({vuln1['cvss']['severity']})")
    print(f"Vector: {vuln1['cvss']['vector_string']}")
    print()

    # XSS
    vuln2 = score_vulnerability(
        "Cross-Site Scripting (XSS)",
        "Reflected XSS in search parameter",
        attack_type="XSS",
        success=True
    )
    print(f"XSS: {vuln2['cvss']['base_score']} ({vuln2['cvss']['severity']})")
    print(f"Vector: {vuln2['cvss']['vector_string']}")
    print()

    # Nmap scan
    vuln3 = score_vulnerability(
        "Open Ports Discovered",
        "Multiple open ports discovered",
        attack_type="Nmap Port Scan",
        success=True
    )
    print(f"Port Scan: {vuln3['cvss']['base_score']} ({vuln3['cvss']['severity']})")
    print(f"Vector: {vuln3['cvss']['vector_string']}")
