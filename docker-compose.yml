# AOPTool - Docker Compose Configuration
# This file defines the entire infrastructure stack

services:
  # ================================
  # DATABASE SERVICES
  # ================================

  postgres:
    image: postgres:15-alpine
    container_name: aoptool_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-aoptool}
      POSTGRES_USER: ${POSTGRES_USER:-aoptool_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init_scripts/postgres:/docker-entrypoint-initdb.d:ro
    networks:
      - aoptool_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-aoptool_user} -d ${POSTGRES_DB:-aoptool}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  mongodb:
    image: mongo:7
    container_name: aoptool_mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-aoptool_user}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-aoptool}
    volumes:
      - mongo_data:/data/db
      - ./init_scripts/mongodb:/docker-entrypoint-initdb.d:ro
    networks:
      - aoptool_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  redis:
    image: redis:7-alpine
    container_name: aoptool_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - aoptool_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  minio:
    image: minio/minio:latest
    container_name: aoptool_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-changeme}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Web Console
    networks:
      - aoptool_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ================================
  # APPLICATION SERVICES
  # ================================

  control_plane:
    build:
      context: ./control_plane
      dockerfile: Dockerfile
    container_name: aoptool_control_plane
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-aoptool}
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-changeme_to_secure_random_string}
      JWT_EXPIRATION_HOURS: ${JWT_EXPIRATION_HOURS:-24}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-changeme}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: ${DEBUG:-false}
    volumes:
      - ./control_plane:/app
      - ./reports:/app/reports
    ports:
      - "8000:8000"
    networks:
      - aoptool_network
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  intelligence_plane:
    build:
      context: ./intelligence_plane
      dockerfile: Dockerfile
    container_name: aoptool_intelligence_plane
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-aoptool}
      MONGODB_URL: mongodb://${MONGODB_USER:-aoptool_user}:${MONGODB_PASSWORD:-changeme}@mongodb:27017/${MONGODB_DATABASE:-aoptool}?authSource=admin
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ENABLE_AI_TRANSLATION: ${ENABLE_AI_TRANSLATION:-true}
      USE_LOCAL_LLM: ${USE_LOCAL_LLM:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PORT: 5000
    volumes:
      - ./intelligence_plane:/app
      - ./training_model:/training_model:ro
      - ./models:/models
    ports:
      - "5000:5000"
    networks:
      - aoptool_network
    command: uvicorn main:app --host 0.0.0.0 --port 5000 --reload
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  execution_plane:
    build:
      context: ./execution_plane
      dockerfile: Dockerfile
    container_name: aoptool_execution_plane
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      DATABASE_URL: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-aoptool}
      MINIO_URL: http://minio:9000
      MINIO_USER: ${MINIO_USER:-minioadmin}
      MINIO_PASSWORD: ${MINIO_PASSWORD:-changeme}
      MAX_CONCURRENT_ATTACKS: ${MAX_CONCURRENT_ATTACKS:-10}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-100}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./execution_plane:/app
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon for tool containers
      - ./tool_outputs:/tool_outputs
      - ./wordlists:/wordlists:ro
    networks:
      - aoptool_network
    privileged: true  # Required for Docker-in-Docker and network operations
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.5'
        reservations:
          memory: 512M
          cpus: '0.5'

  celery_worker:
    build:
      context: ./execution_plane
      dockerfile: Dockerfile
    container_name: aoptool_celery_worker
    depends_on:
      redis:
        condition: service_healthy
      execution_plane:
        condition: service_started
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      DATABASE_URL: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-aoptool}
      CELERY_WORKER_CONCURRENCY: ${CELERY_WORKER_CONCURRENCY:-4}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./execution_plane:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./tool_outputs:/tool_outputs
    networks:
      - aoptool_network
    command: celery -A tasks worker --loglevel=info --concurrency=${CELERY_WORKER_CONCURRENCY:-4} --max-tasks-per-child=100
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '1.0'

  celery_beat:
    build:
      context: ./execution_plane
      dockerfile: Dockerfile
    container_name: aoptool_celery_beat
    depends_on:
      redis:
        condition: service_healthy
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./execution_plane:/app
      - celery_beat_data:/var/lib/celery
    networks:
      - aoptool_network
    command: celery -A tasks beat --loglevel=info --schedule=/var/lib/celery/celerybeat-schedule
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  web_dashboard:
    build:
      context: ./web_dashboard
      dockerfile: Dockerfile
    container_name: aoptool_web_dashboard
    depends_on:
      control_plane:
        condition: service_healthy
    environment:
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8000}
      REACT_APP_WS_URL: ${REACT_APP_WS_URL:-ws://localhost:8000/ws}
      NODE_ENV: ${ENVIRONMENT:-development}
    volumes:
      - ./web_dashboard:/app
      - /app/node_modules  # Prevent node_modules from being overwritten
    ports:
      - "3000:3000"
    networks:
      - aoptool_network
    restart: unless-stopped
    command: npm start
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  reporting_plane:
    build:
      context: ./reporting_plane
      dockerfile: Dockerfile
    container_name: aoptool_reporting_plane
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-aoptool}
      REPORT_OUTPUT_DIR: /app/reports
      PORT: 6000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./reporting_plane:/app
      - ./reports:/app/reports
    ports:
      - "6000:6000"
    networks:
      - aoptool_network
    restart: unless-stopped
    command: python main.py
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M

  # ================================
  # MONITORING & ML SERVICES (Optional)
  # ================================

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.2
    container_name: aoptool_mlflow
    environment:
      BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/mlflow
      ARTIFACT_ROOT: s3://mlflow-artifacts
      AWS_ACCESS_KEY_ID: ${MINIO_USER:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${MINIO_PASSWORD:-changeme}
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    ports:
      - "5000:5000"
    networks:
      - aoptool_network
    command: >
      mlflow server
      --backend-store-uri postgresql://${POSTGRES_USER:-aoptool_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/mlflow
      --default-artifact-root s3://mlflow-artifacts
      --host 0.0.0.0
      --port 5000
    profiles: ["monitoring"]
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ================================
  # PENTESTING TOOLS (On-Demand)
  # ================================
  # These are launched on-demand by execution_plane
  # Include here for reference and optional standalone use

  nmap:
    image: instrumentisto/nmap:latest
    container_name: aoptool_nmap
    network_mode: host  # Required for proper port scanning
    command: sleep infinity
    profiles: ["tools"]
    restart: "no"

  metasploit:
    image: metasploitframework/metasploit-framework:latest
    container_name: aoptool_metasploit
    command: msfrpcd -P ${MSF_PASSWORD:-changeme} -S -a 0.0.0.0
    ports:
      - "55553:55553"
    networks:
      - aoptool_network
    profiles: ["tools"]
    restart: "no"

  sqlmap:
    image: paoloo/sqlmap:latest
    container_name: aoptool_sqlmap
    command: sleep infinity
    networks:
      - aoptool_network
    profiles: ["tools"]
    restart: "no"

  zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: aoptool_zap
    command: zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.key=${ZAP_API_KEY:-changeme}
    ports:
      - "8081:8080"
    networks:
      - aoptool_network
    profiles: ["tools"]
    restart: "no"

  nuclei:
    image: projectdiscovery/nuclei:latest
    container_name: aoptool_nuclei
    command: sleep infinity
    volumes:
      - nuclei_templates:/root/nuclei-templates
    networks:
      - aoptool_network
    profiles: ["tools"]
    restart: "no"

  gobuster:
    image: nusakun/gobuster:latest
    container_name: aoptool_gobuster
    command: sleep infinity
    volumes:
      - ./wordlists:/wordlists:ro
    networks:
      - aoptool_network
    profiles: ["tools"]
    restart: "no"

# ================================
# NETWORKS
# ================================

networks:
  aoptool_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ================================
# VOLUMES
# ================================

volumes:
  postgres_data:
    driver: local
  mongo_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  celery_beat_data:
    driver: local
  nuclei_templates:
    driver: local

# ================================
# USAGE
# ================================
# Start all core services:
#   docker-compose up -d
#
# Start with monitoring:
#   docker-compose --profile monitoring up -d
#
# Start with tools:
#   docker-compose --profile tools up -d
#
# View logs:
#   docker-compose logs -f [service_name]
#
# Stop all:
#   docker-compose down
#
# Remove all data (CAUTION):
#   docker-compose down -v
#
# Rebuild specific service:
#   docker-compose build [service_name]
#   docker-compose up -d [service_name]
